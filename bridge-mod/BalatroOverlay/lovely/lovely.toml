# Lovely mod loader configuration for BalatroOverlay
# https://github.com/ethangreen-dev/lovely-injector

[manifest]
version = "1.3.0"
dump_lua = true
priority = 0

# =============================================================================
# MODULE REGISTRATION
# =============================================================================

# Register the BalatroOverlay module before main.lua loads
[[patches]]
[patches.module]
source = "BalatroOverlay.lua"
before = "main.lua"
name = "BalatroOverlay"

# =============================================================================
# INITIALIZATION HOOKS
# =============================================================================

# Initialize the mod after love.load
# Pattern from dump: "function love.load() " (note trailing space)
[[patches]]
[patches.pattern]
target = "main.lua"
pattern = "function love.load()"
position = "after"
match_indent = false
payload = '''
    BalatroOverlay = require("BalatroOverlay")
    BalatroOverlay.init()
'''

# =============================================================================
# UPDATE LOOP
# =============================================================================

# Call update every frame for state export
# Pattern from dump: "function love.update( dt )" (note spaces inside parens)
[[patches]]
[patches.pattern]
target = "main.lua"
pattern = "function love.update( dt )"
position = "after"
match_indent = false
payload = '''
    if BalatroOverlay then
        BalatroOverlay.update(dt)
    end
'''

# =============================================================================
# GAME EVENT HOOKS
# =============================================================================

# Hook into new run start to clear history
# Pattern from dump: "G.FUNCS.start_run = function(e, args)"
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "G.FUNCS.start_run = function(e, args)"
position = "after"
match_indent = false
payload = '''
    if BalatroOverlay then
        BalatroOverlay.onNewRun()
    end
'''

# =============================================================================
# DISCARD/PLAY HOOKS (for immediate state updates)
# =============================================================================

# Hook into discard action
# Pattern from dump: "G.FUNCS.discard_cards_from_highlighted = function(e, hook)"
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "G.FUNCS.discard_cards_from_highlighted = function(e, hook)"
position = "after"
match_indent = false
payload = '''
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''

# Hook into play hand action
# Pattern from dump: "G.FUNCS.play_cards_from_highlighted = function(e)"
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "G.FUNCS.play_cards_from_highlighted = function(e)"
position = "after"
match_indent = false
payload = '''
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''

# =============================================================================
# SHOP HOOKS
# =============================================================================

# Hook into reroll for shop state update
# Pattern from dump: "G.FUNCS.reroll_shop = function(e)"
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "G.FUNCS.reroll_shop = function(e)"
position = "after"
match_indent = false
payload = '''
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''
