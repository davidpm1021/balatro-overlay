# Lovely mod loader configuration for BalatroOverlay
# https://github.com/ethangreen-dev/lovely-injector

[manifest]
version = "1.2.0"
dump_lua = false
priority = 0

# =============================================================================
# MODULE REGISTRATION
# =============================================================================

# Register the BalatroOverlay module before main.lua loads
# This makes it available via require("BalatroOverlay")
[[patches]]
[patches.module]
source = "BalatroOverlay.lua"
before = "main.lua"
name = "BalatroOverlay"

# =============================================================================
# INITIALIZATION HOOKS
# =============================================================================

# Initialize the mod after love.load
[[patches]]
[patches.pattern]
target = "main.lua"
pattern = "function love.load()"
position = "after"
match_indent = true
payload = '''
    BalatroOverlay = require("BalatroOverlay")
    BalatroOverlay.init()
'''

# =============================================================================
# UPDATE LOOP
# =============================================================================

# Call update every frame for state export
[[patches]]
[patches.pattern]
target = "main.lua"
pattern = "function love.update(dt)"
position = "after"
match_indent = true
payload = '''
    if BalatroOverlay then
        BalatroOverlay.update(dt)
    end
'''

# =============================================================================
# GAME EVENT HOOKS
# =============================================================================

# Hook into new run start to clear history
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "function Game:start_run(args)"
position = "after"
match_indent = true
payload = '''
    if BalatroOverlay then
        BalatroOverlay.onNewRun()
    end
'''

# =============================================================================
# DRAW/DISCARD/PLAY HOOKS (for immediate state updates)
# =============================================================================

# Hook into discard action
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "function G.FUNCS.discard_cards_from_highlighted"
position = "after"
match_indent = true
payload = '''
    -- BalatroOverlay: Force state update on discard
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''

# Hook into play hand action
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "function G.FUNCS.play_cards_from_highlighted"
position = "after"
match_indent = true
payload = '''
    -- BalatroOverlay: Force state update on play
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''

# =============================================================================
# SHOP HOOKS
# =============================================================================

# Hook into shop enter for shop state capture
[[patches]]
[patches.pattern]
target = "functions/state_events.lua"
pattern = "function Game:shop()"
position = "after"
match_indent = true
payload = '''
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''

# Hook into reroll for shop state update
[[patches]]
[patches.pattern]
target = "functions/button_callbacks.lua"
pattern = "function G.FUNCS.reroll_shop"
position = "after"
match_indent = true
payload = '''
    if BalatroOverlay then
        pcall(function() BalatroOverlay.exportState() end)
    end
'''
